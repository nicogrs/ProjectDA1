@page "/account/login"
@using Dominio.Data
@using DTOs
@inject NavigationManager Navigation
@inject Session Session
@inject UserDataBase UDatabase

<h3>Login</h3>

<EditForm Model="modelLogin" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Email</label>
        <InputText @bind-Value="modelLogin.Email" />
    </div>

    <div class="form-group">
        <label>Contraseña</label>
        <InputText @bind-Value="modelLogin.Password" type="password" />
    </div>

    <div class="form-group">
        <button class="btn btn-primary" type="submit">Ingresar</button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
    }
</EditForm>


@code {
    private UserLoginDTO modelLogin = new UserLoginDTO();
    private string errorMessage;
    
    
    private void HandleLogin()
    {
        var user = UDatabase.GetUserByEmail(modelLogin.Email);
        if (user != null && user.Password == modelLogin.Password)
        {
            modelLogin = UserLoginDTO.FromEntity(user);
            Navigation.NavigateTo("/");
            Session.Login(user);
            StateHasChanged();
        }
        else
        {
            errorMessage = "El email o la contraseña son incorrectos.";
            modelLogin = new UserLoginDTO();
        }
    }

}


