@page "/{teamName}/{panelId}/create"
@using Dominio
@using Dominio.Data
@using Task = Dominio.Task
@inject PanelService PlService
@inject NavigationManager Navigation
@inject Session Session

<PageTitle>Create Task</PageTitle>
<h3>Crear Tarea</h3>
@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-success" role="alert">
        @message
    </div>
}
<EditForm Model="modelCreateTask" OnValidSubmit="HandleCreate">
    <DataAnnotationsValidator/>
    <div class="form-group">
        <label id="name">Nombre</label>
        <InputText class="form-control" @bind-Value="@modelCreateTask.Title" id="name"></InputText>
        <ValidationMessage For="@(() => modelCreateTask.Title)"/>
    </div>
    <div class="form-group">
        <label id="userAmount">Prioridad</label>
        <select class="form-control" Value="@selectedPriority" id="userAmount">
            @foreach (var priority in Enum.GetValues(typeof(Task.Priority)))
            {
                <option value="@priority">@priority.ToString()</option>
            }
        </select>
        <ValidationMessage For="@(() => modelCreateTask.Precedence)"/>
    </div>
    <div class="form-group">
        <label for="lastName">Descripcion</label>
        <InputText class="form-control" @bind-Value="@modelCreateTask.Description" id="lastName"></InputText>
        <ValidationMessage For="@(() => modelCreateTask.Description)"/>
    </div>

    <div class="form-group">
        <label for="birthDate">Fecha de expiración</label>
        <InputDate class="form-control" id="birthDate" @bind-Value="@modelCreateTask.ExpirationDate" min=@DateTime.Today.ToString()></InputDate>
        <ValidationMessage For="@(() => modelCreateTask.ExpirationDate)"/>
    </div>
    <div class="form-group">
        <button class="btn btn-primary" type="submit">Crear Tarea</button>
    </div>
    <div class="col-4">
        <button class="btn btn-primary" type="submit" @onclick="GoBack">Volver</button>
    </div>
</EditForm>

@code {
    [Parameter]
    public string teamName { get; set; }
    [Parameter]
    public string panelId { get; set; }

    private Task.Priority selectedPriority;
    
    Task modelCreateTask = new Task();
    private string message;
    
    protected override void OnInitialized()
    {
        if (Session.CurrentUser == null)
        {
            Navigation.NavigateTo("/error");
        }
    }
    
    
    private void HandleCreate()
    {
        Task t = new Task
        {
            Title = modelCreateTask.Title,
            Precedence = selectedPriority,
            Description = modelCreateTask.Description,
            ExpirationDate = modelCreateTask.ExpirationDate,
            Comments = null
        };
        PlService.GetPanelById(teamName, int.Parse(panelId)).AddTask(t);
        message="Tarea creada con éxito";
    } 
    private void GoBack()
    {
        Navigation.NavigateTo($"/{teamName}/{panelId}/tasks");
    }
}