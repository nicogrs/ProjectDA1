@page "/{teamName}/{panelName}/create"

@using Dominio.Data
@using Task = Dominio.Task
@using Logica
@inject TaskDatabase Database
@inject NavigationManager Navigation
@inject Session Session


<PageTitle>Create Team</PageTitle>
<h3>Agregar Equipo</h3>
<EditForm Model="modelCreateTask" OnValidSubmit="HandleCreate">
    <DataAnnotationsValidator/>
    <div class="form-group">
        <label id="name">Nombre</label>
        <InputText class="form-control" @bind-Value="@modelCreateTask.Title" id="name"></InputText>
        <ValidationMessage For="@(() => modelCreateTask.Title)"/>
    </div>
    <div class="form-group">
        <label id="userAmount">Prioridad</label>
        <InputNumber class="form-control" @bind-Value="@modelCreateTask.Precedence" id="userAmount"></InputNumber>
        <ValidationMessage For="@(() => modelCreateTask.Precedence)"/>
    </div>
    <div class="form-group">
        <label for="lastName">Descripcion</label>
        <InputText class="form-control" @bind-Value="@modelCreateTask.Description" id="lastName"></InputText>
        <ValidationMessage For="@(() => modelCreateTask.Description)"/>
    </div>

    <div class="form-group">
        <label for="birthDate">Fecha de expriracion</label>
        <InputDate class="form-control" id="birthDate" @bind-Value="@modelCreateTask.ExpirationDate" min="1900-01-01"></InputDate>
        <ValidationMessage For="@(() => modelCreateTask.ExpirationDate)"/>
    </div>
    <div class="form-group">
        <button class="btn btn-primary" type="submit">Crear Grupo</button>
    </div>
    <div class="col-4">
        <button class="btn btn-primary" type="submit" @onclick="GoBack">Volver</button>
    </div>
    <div class="alert alert-danger" role="alert">
        @createMessage
    </div>

</EditForm>

@code {
   
    Task modelCreateTask = new Task();
    private string createMessage;
    
    [Parameter]
    public string teamName { get; set; }
    [Parameter]
    public string panelName { get; set; }
    
    protected override void OnInitialized()
    {
        if (Session.CurrentUser == null)
        {
            Navigation.NavigateTo("/error");
        }
    }
    
    
    private void HandleCreate()
    {
        Task t = new Task
        {
            Title = modelCreateTask.Title,
            Precedence = modelCreateTask.Precedence,
            Description = modelCreateTask.Description,
            ExpirationDate = modelCreateTask.ExpirationDate,
            Comments = null
        };
        Database.Tasks.Add(t);
        Session.GetPanels(teamName).Find(x => x.Name == panelName).Tasks.Add(t);
        createMessage="Tarea creado con Ã©xito";
    } 
    private void GoBack()
    {
        Navigation.NavigateTo($"/{teamName}/{panelName}/tasks");
    }
}