
@using Dominio
@using Dominio.Data
@using Task = Dominio.Task
@inject PanelService PlService
@inject TaskService TkService
@inject NavigationManager Navigation
@inject Session Session

<div class="card">
    <div class="card-body">
        <p class="card-title">@Title</p>
        <div class="d-flex justify-content-between">
            <p class="card-text">@Precedence.ToString()</p>
            <p class="card-text">@EndDate</p>
        </div>
        <p class="card-text">@Description</p>
        @if (Comments != null && Comments.Count > 0)
        {
            foreach (var comment in Comments)
            {
                <div class="card-text border-bottom mb-2 pb-2">
                    <p>@comment.Content</p>
                    <div class="form-group">
                        <button class="btn btn-primary" type="submit" @onclick="() => CompleteComment(comment)">Terminar</button>
                    </div>
                </div>
                
            }
        }
    </div>
    <div class="card-footer">
        <div class="form-group">
            <button class="btn btn-primary" type="submit" @onclick="AddComment">Agregar Comentario</button>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" type="submit" @onclick="ChangeTask">Modificar</button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Title { get; set; }
    [Parameter]
    public Task.Priority Precedence { get; set; }
    [Parameter]
    public DateTime EndDate { get; set; }
    [Parameter]
    public string Description { get; set; }
    [Parameter]
    public string teamName { get; set; }
    [Parameter]
    public string panelId { get; set; }
    [Parameter]
    public List<Comment> Comments { get; set; }
    

    protected override void OnInitialized()
    {
        //Comments = PlService.GetPanelById(teamName, panelId).Tasks.FirstOrDefault(t => t.Title.Equals(Title)).Comments;
    }

    private void AddComment()
    {
        Navigation.NavigateTo($"/{teamName}/{panelId}/{Title}/createComment");
    }
    private void ChangeTask()
    {
        Navigation.NavigateTo($"/{teamName}/{panelId}/{Title}");
    }

    private void CompleteComment(Comment comment)
    {
        PlService.GetPanelById(teamName, int.Parse(panelId)).Tasks.FirstOrDefault(t => t.Title.Equals(Title)).MarkCommentAsResolved(Session.CurrentUser, comment);
    }
}